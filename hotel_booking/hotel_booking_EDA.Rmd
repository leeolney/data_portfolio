---
title: "Hotel booking cancellations - Part 1"
output:
  html_document:
    df_print: paged
---

## Dataset
[Hotel Booking Demand](https://www.kaggle.com/jessemostipak/hotel-booking-demand) 

## Research question
* What are the key variables for predicting hotel booking cancellations? 
    + logistic regression, decision tree, random forest

## Load libraries
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(Hmisc)
library(psych)
library(skimr)
library(GGally)
```

## Import data
```{r}
df=read.csv("hotel_bookings.csv",header=TRUE)
dim(df)
str(df)
```

## Data preparation

**Missing value analysis**
```{r}
mva = apply(ifelse(df == 'NULL', 1, 0), 2, sum)
df = df %>% mutate_at(vars(children), ~replace(.,is.na(.),0))
summary(df$children)
```

**Change variable type**
```{r}
df = df %>% mutate_at (vars(is_canceled,arrival_date_year,arrival_date_week_number,is_repeated_guest), list(factor))
df$reservation_status_date = as.Date(df$reservation_status_date)
```

**Create new variables**
```{r}
df1=df 
df1$nights= df1$stays_in_weekend_nights + df1$stays_in_week_nights
df1$people= df1$adults + df1$children + df1$babies
df1$children_babies= df1$children + df1$babies
df1$is_family= ifelse(df1$children_babies>=1,"1","0")
df1$is_waitlisted= ifelse(df1$days_in_waiting_list>=1,"1","0")
df1$reserved_room_type = as.character(df1$reserved_room_type)
df1$assigned_room_type = as.character(df1$assigned_room_type)
df1$room_type_change= ifelse(df1$reserved_room_type == df1$assigned_room_type,"0","1")
df1$company = as.character(df1$company)
df1$agent = as.character(df1$agent)
df1$from_company = ifelse(grepl("NULL", df1$company),0,1)
df1$from_agent = ifelse(grepl("NULL", df1$agent),0,1)
df1$has_pcancel = ifelse(df1$previous_cancellations>=1,"1","0")
df1$has_pbnc = ifelse(df1$previous_bookings_not_canceled>=1,"1","0")
df1$has_bchanges = ifelse(df1$booking_changes>=1,"1","0")
df1$has_srequests = ifelse(df1$total_of_special_requests>=1,"1","0")
df1$req_parking = ifelse(df1$required_car_parking_spaces>=1,"1","0")
```

**Summary** 
```{r}
df1 = df1 %>% mutate_at (vars(reserved_room_type,assigned_room_type, room_type_change, is_family, is_waitlisted, agent,company, has_pcancel, has_pbnc, has_bchanges, has_srequests, from_company, from_agent, req_parking), list(factor))
skim(df1)
```

## Vizualisations 
**is canceled and hotel**
```{r}
Hmisc::describe(df1$hotel)
table(df1$is_canceled,df1$hotel)
ggplot(df1, aes(x= is_canceled,  group=hotel)) + 
    geom_bar(aes(y = ..prop.., fill = factor(..x..)), stat="count") +
    geom_text(aes( label = scales::percent(..prop..),
                   y= ..prop.. ), stat= "count", vjust = -.5) +
    labs(y = "Percent", fill="is_canceled") +
    facet_grid(~hotel) +
    scale_y_continuous(labels = scales::percent)
```

**Pair plot 1**
```{r, message = FALSE, warning = FALSE}
df1 %>% select (is_canceled, is_waitlisted, is_repeated_guest, deposit_type) %>% ggpairs(mapping = aes(color=is_canceled))
```

**Pair plot 2**
```{r, message = FALSE, warning = FALSE}
df1 %>% select (is_canceled, has_bchanges, has_srequests, req_parking, has_pcancel) %>% ggpairs(mapping = aes(color=is_canceled))
```

**month, is_canceled and hotel**
```{r}
Hmisc::describe(df1$arrival_date_year)
table(df1$arrival_date_year, df1$arrival_date_month)
df1 %>%
  mutate(arrival_date_month = factor(arrival_date_month,
    levels = month.name
  )) %>%
  count(hotel, arrival_date_month, is_canceled) %>%
  group_by(hotel, is_canceled) %>%
  mutate(proportion = n / sum(n)) %>%
  ggplot(aes(arrival_date_month, proportion, fill = is_canceled)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~hotel, nrow = 2) +
  labs(
    x = NULL,
    y = "proportion of is_canceled",
    fill = NULL
  )
```

**is_canceled, is_family and hotel**
```{r}
table(df1$is_family,df1$hotel)  
df1 %>%
  count(hotel,is_canceled, is_family) %>%
  group_by(hotel, is_family) %>%
  mutate(proportion = n / sum(n)) %>%
  ggplot(aes(is_canceled, proportion, fill = is_family)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~hotel, nrow = 2) +
  labs(
    x = "is_canceled",
    y = "proportion",
    fill = "is_family"
  )
```

**distribution_channel, is_canceled and hotel**
```{r}
ggplot(df1, aes(x = distribution_channel, y = lead_time, fill = is_canceled)) + geom_boxplot(position = position_dodge()) +
  facet_wrap(~hotel, nrow = 5) +
  labs(
    x = "distribution_channel",
    y = "lead_time",
    fill = "is_canceled"
  )
```

**market_segment, is_canceled and hotel**
```{r}
df1 %>%
  count(hotel,market_segment, is_canceled) %>%
  group_by(hotel, is_canceled) %>%
  mutate(proportion = n / sum(n)) %>%
  ggplot(aes(market_segment, proportion, fill = is_canceled)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~hotel, nrow = 2) +
  labs(
    x = "market_segment",
    y = "proportion",
    fill = "is_canceled"
  )
```

**customer_type and hotel**
```{r}
checkout = df1 %>% filter(reservation_status == 'Check-Out') 
dim(checkout)
ggplot(checkout, aes(customer_type, fill=hotel)) + geom_bar(stat='count', position=position_dodge())
```

**customer_type, avg. people and hotel**
```{r}
ggplot(checkout, aes(x= customer_type, y=people, fill= customer_type)) + geom_bar(stat="summary", fun="mean", position=position_dodge()) + facet_wrap(~hotel, nrow = 2)
```

**customer_type, adr and hotel**
```{r}
ggplot(checkout, aes(x = customer_type, y = adr, fill = hotel)) + geom_boxplot(position = position_dodge())
```

**market_segment and customer_type**
```{r}
ggplot(checkout) + geom_bar(aes(x= market_segment, fill= customer_type)) + facet_wrap(~hotel, nrow = 2)
```

## Subset for data modeling 

### Country
**Summary of country levels** 
```{r}
country1 = count(df1,country)
summary(country1$n)
```

**Select countries with >1500 count**
```{r}
subc = df1 %>% 
  group_by(country) %>% 
  filter(n() > 1500) %>%
  as.data.frame()
dim(subc)
Hmisc::describe(subc$country)
```

### Outliers in ADR
```{r}
boxplot(subc$adr)
```

### Drop observations 
```{r}
df2= subc 
df2 = df2[df2$adr !=5400,]
df2=df2[df2$reserved_room_type !="P",]
df2=df2[df2$reserved_room_type !="L",]
df2=df2[df2$distribution_channel !="Undefined",]
df2=df2[df2$market_segment !="Undefined",]
df3a = df2[ df2$stays_in_weekend_nights> 0 | df2$stays_in_week_nights>0 ,]
dim(df3a)
df3b = df2[ df2$stays_in_weekend_nights== 0 & df2$stays_in_week_nights ==0 ,]
dim(df3b)
```

### Export subset
```{r}
write.csv(df3a, "df3a.csv", row.names = FALSE)
```





