---
title: "R Notebook"
output: html_notebook
---

Notebook description: EDA and churn prediction  
Dataset: [Credit card customers](https://www.kaggle.com/sakshigoyal7/credit-card-customers/tasks?taskId=2729)
Dataset description: 10127 customers with 18 features including age, salary, martial status, credit card limit, credit card category etc. 

Clear environment
```{r}
rm(list=ls())
```

Load packages
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(skimr)
library(Hmisc)
library(ggsci)
library(caret)
library(ggpubr)
library(gridExtra)
library(corrplot)
library(rpart)
library(rpart.plot)
library(rattle)
library(randomForest)
library(caret)
library(pscl)
library(pROC)
```

Import data
```{r}
df = read.csv("BankChurners.csv", header=TRUE)
head(df)
#delete naive bayes columns
df = df[,2:21]
#check customer duplicates 
count(distinct(df, CLIENTNUM)) #no duplicates
#missing
sum(is.na(df))
```

```{r}
dim(df)
colnames(df)
```

Target variable
```{r}
Hmisc::describe(df$Attrition_Flag)
```
* Out of 10127 obs, 1627 (16.1%) are attrited customers suggesting an imbalanced dataset. 

```{r}
#convert target variable to numeric 
df$label= ifelse(df$Attrition_Flag =="Attrited Customer","1","0")
Hmisc::describe(df$label)
#drop attrition flag 
df = subset(df, select = -c(Attrition_Flag))
```


```{r}
#summary
df_cat = df %>% select(Gender,Education_Level,Income_Category,Marital_Status,Card_Category) %>% mutate_all(list(factor))
summary(df_cat)
df_num = df %>% select (Customer_Age,Dependent_count,Months_on_book,Total_Relationship_Count,Months_Inactive_12_mon,Contacts_Count_12_mon, Credit_Limit,Total_Revolving_Bal,Avg_Open_To_Buy,Total_Amt_Chng_Q4_Q1,Total_Trans_Amt,Total_Trans_Ct,Total_Ct_Chng_Q4_Q1,Avg_Utilization_Ratio)
skim(df_num)
```
Apply one-hot encoding to categorical variables
```{r}
df_cat = df %>% select(Gender,Education_Level,Income_Category,Marital_Status,Card_Category)
dummy = dummyVars(" ~ .", data = df_cat)
df_cat_new= data.frame(predict(dummy, newdata = df_cat))
head(df_cat_new)
```
Bind categorical and numeric vars
```{r}
df_new = cbind(df,df_cat_new)
df_new = df_new %>% select(-c(Gender,Education_Level,Income_Category,Marital_Status,Card_Category))
dim(df_new)
colnames(df_new)
```


###EDA
####Correlation
```{r}
df = df %>% mutate_at(vars(Gender,Education_Level,Income_Category,Marital_Status,Card_Category),list(factor))
df$label = as.numeric(df$label)
data_corr <- df %>% mutate_if(is.factor,as.numeric)
correlation= cor(data_corr)
target_corr= as.data.frame(correlation[,])
target_corr2 = target_corr[tail(names(target_corr), 1)]
colnames(target_corr2) = 'Correlation'
target_corr2
```

```{r}
target_corr2 = target_corr2 %>% filter(Correlation<1)
target_corr2 %>% ggplot(aes(x=Correlation, y=reorder(rownames(target_corr2), Correlation))) + geom_col(fill="#457b9d") + labs(y="") + theme_light()
```

```{r}
df$label = as.factor(df$label)
p1 = df %>% group_by(label,Contacts_Count_12_mon) %>% tally() %>% mutate(prop=n/sum(n)) %>% ggplot(aes(x=Contacts_Count_12_mon, y=prop,fill=label)) + geom_col(position="dodge") + scale_fill_jama() + labs(y="proportion") + theme_light() + theme(legend.position="bottom")
p2 = df %>% group_by(label,Months_Inactive_12_mon) %>% tally() %>% mutate(prop=n/sum(n)) %>% ggplot(aes(x=Months_Inactive_12_mon, y=prop,fill=label)) + geom_col(position="dodge") + scale_fill_jama() + labs(y="proportion") + theme_light() + theme(legend.position="bottom")
p3 = df %>% ggplot(aes(x=Total_Trans_Ct, fill=label)) + geom_density(alpha=0.6) + scale_fill_jama() + theme_light() 
p4 = df %>% ggplot(aes(x=Total_Ct_Chng_Q4_Q1, fill=label)) + geom_density(alpha=0.6) + scale_fill_jama() + theme_light()
p5 = df %>% ggplot(aes(x=Total_Revolving_Bal, fill=label)) + geom_density(alpha=0.6) + scale_fill_jama() + theme_light()
p6 = df %>% ggplot(aes(x=Avg_Utilization_Ratio, fill=label)) + geom_density(alpha=0.6) + scale_fill_jama() + theme_light()
p7 = df %>% ggplot(aes(x=Total_Trans_Amt, fill=label)) + geom_density(alpha=0.6) + scale_fill_jama() + theme_light()
p8 = df %>% group_by(label,Total_Relationship_Count) %>% tally() %>% mutate(prop=n/sum(n)) %>% ggplot(aes(x=Total_Relationship_Count, y=prop,fill=label)) + geom_col(position="dodge") + scale_fill_jama() + labs(y="proportion") + theme_light()
grid.arrange(p1,p2,ncol=2,nrow=1)
grid.arrange(p3,p4,ncol=1,nrow=2)
grid.arrange(p5,p6,ncol=1,nrow=2)
grid.arrange(p7,p8,ncol=1,nrow=2)
```

###Check correlation of numeric variables 
```{r}
#check correlation of all numeric variables
res=cor(df_num)
corrplot(res, tl.col="#636363",tl.cex=0.5)
```

###Test and train spilt 
```{r}
set.seed(678)
y1= sample(1:10127,8101)
xtrain=df[y1,]
xtest=df[-y1,]
Hmisc:: describe(xtrain$label)
Hmisc:: describe(xtest$label)
```


###Find variable importance 
####Decision Tree
```{r}
mt = rpart(label ~., data = xtrain, method = "class")
fancyRpartPlot(mt)
printcp(mt)
mt$variable.importance
plotcp(mt)
```

```{r}
mt_prune = prune(mt,cp=0.12)
fancyRpartPlot(mt_prune)
printcp(mt_prune)
mt_prune$variable.importance
```

```{r}
v1 = data.frame(imp = mt_prune$variable.importance)
v2 <- v1 %>% 
  tibble::rownames_to_column() %>% 
  dplyr::rename("variable" = rowname) %>% 
  dplyr::arrange(imp) %>%
  dplyr::mutate(variable = forcats::fct_inorder(variable))
ggplot2::ggplot(v2) +
  geom_segment(aes(x = variable, y = 0, xend = variable, yend = imp), 
               size = 1, alpha = 0.7) +
  geom_point(aes(x = variable, y = imp), 
             size = 2, show.legend = F) +
  coord_flip() +
  theme_light() + labs(y="Importance", title="dt")
```

```{r}
tree.p = predict(mt_prune, xtest, type = "class")
cmt = confusionMatrix(tree.p, xtest$label, positive ="1")
cmt
round(cmt$byClass["F1"], 4)
xtest$tp1= tree.p
roc_t1= roc(response= xtest$label, predictor = factor(xtest$tp1, ordered=TRUE), plot=TRUE, print.auc=TRUE)
```
* 241 out of 323 positive instances were predicted correctly (0.755 recall/sensitivity)


####Logistic regression
```{r}
model1= glm(label ~., data=xtrain, family = "binomial")
summary(model1) 
pR2(model1)  
anova(model1, test= "Chisq")
```
```{r, message = FALSE, warning = FALSE}
prob=predict(model1,xtest,type="response")
prob1=rep(0,2026)
prob1[prob>0.5]=1
cmlr = confusionMatrix(as.factor(prob1), xtest$label, positive ="1")
cmlr
round(cmlr$byClass["F1"], 4)
roc_lr = roc(xtest$label, prob1, plot=TRUE, print.auc=TRUE)
```
* 185 out of 323 positive instances were predicted correctly (0.57 recall/sensitivity)

###Select variables 

```{r}
#check correlation of all numeric variables
res=cor(df_num)
corrplot(res, tl.col="#636363",tl.cex=0.5)
```

drop Months_on_book,Total_Trans_Amt, Total_Amt_Chng_Q4_Q1, Avg_Utilization_Ratio
```{r}
xtrain1 = xtrain %>% select(-c(Months_on_book,Total_Trans_Amt, Total_Amt_Chng_Q4_Q1, Avg_Utilization_Ratio))
xtest1 = xtest %>% select(-c(Months_on_book,Total_Trans_Amt, Total_Amt_Chng_Q4_Q1, Avg_Utilization_Ratio))
dim(xtrain1)
dim(xtest1)
```

```{r}
res=cor(df_num)
corrplot(res, tl.col="#636363",tl.cex=0.5)
```


```{r}
mt = rpart(label ~., data = xtrain1, method = "class")
plotcp(mt)
```
```{r}
v1 = data.frame(imp = mt$variable.importance)
v2 <- v1 %>% 
  tibble::rownames_to_column() %>% 
  dplyr::rename("variable" = rowname) %>% 
  dplyr::arrange(imp) %>%
  dplyr::mutate(variable = forcats::fct_inorder(variable))
ggplot2::ggplot(v2) +
  geom_segment(aes(x = variable, y = 0, xend = variable, yend = imp), 
               size = 1, alpha = 0.7) +
  geom_point(aes(x = variable, y = imp), 
             size = 2, show.legend = F) +
  coord_flip() +
  theme_light() + labs(y="Importance", title="dt")
```

```{r}
mt_prune = prune(mt,cp=0.015)
fancyRpartPlot(mt_prune)
printcp(mt_prune)
mt_prune$variable.importance
```
```{r}
tree.p = predict(mt2_prune, xtest1, type = "class")
cmt = confusionMatrix(tree.p, xtest1$label, positive ="1")
cmt
round(cmt$byClass["F1"], 4)
xtest1$tp1= tree.p
roc_t2= roc(response= xtest$label, predictor = factor(xtest1$tp1, ordered=TRUE), plot=TRUE, print.auc=TRUE)
```

