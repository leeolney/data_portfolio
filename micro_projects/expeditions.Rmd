---
title: "Expeditions - EDA and Modeling Exercise "
date: "Dec 2020"
output: html_notebook
---

**Practice goals**:  

* learn [tidymodels](https://www.tidymodels.org/) modeling workflow using [Julia Siege's walkthrough](https://juliasilge.com/blog/himalayan-climbing/)   

* customize ggplots  

* visualize model results   

**Dataset**: 
TidyTuesday [Himalayan Climbing Expeditions](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-09-22/readme.md) from [The Himalayan Database](https://www.himalayandatabase.com/), shared and cleaned by [Alex Cookson](https://twitter.com/alexcookson).



### Load packages
```{r, message=FALSE}
library(tidyverse)
library(tidymodels)
library(skimr)
library(doParallel)
library(vip)
library(parttree) 
library(ggsci)
library(wesanderson)
library(ggdark)
library(gridExtra)
library(themis)
library(ggtext)
```

### Import data
```{r, message=FALSE}
members <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-22/members.csv")
expeditions <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-22/expeditions.csv')
peaks <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-09-22/peaks.csv')
```

### Missing data analysis
```{r}
skimr::skim(members)
```

### Section 1: EDA 

```{r,message=FALSE}
#death of climbers compared to guides
deaths <- members %>% 
  filter(died) %>% 
  mutate(
    expedition_role = if_else(expedition_role == "H-A Worker", "guides", "climbers"),
    death_cause = case_when(
      death_cause == "Unknown" ~ "Other and unknown",
      death_cause == "Other" ~ "Other and unknown",
      death_cause == "Falling rock / ice" ~ "Falling rock or ice",
      death_cause == "Crevasse" ~ "Fall into a crevasse",
      death_cause == "Disappearance (unexplained)" ~ "Disappearance",
      death_cause == "Exposure / frostbite" ~ "Exposure",
      death_cause == "Illness (non-AMS)" ~ "Illness",
      death_cause == "AMS" ~ "Acute mountain sickness",
      TRUE ~ death_cause
    )
    ) %>% 
  count(death_cause, expedition_role) %>% 
  group_by(death_cause) %>% 
  mutate(total = sum(n)) %>% 
  ungroup() %>% 
  mutate(death_cause = fct_reorder(death_cause, total))

#plot
deaths %>% ggplot(aes(x=death_cause,y=n,fill=expedition_role)) + geom_col(width=0.4, alpha=0.8) + 
  coord_flip() + dark_theme_minimal() + 
  theme(legend.position="top",plot.title = element_text(color="#e5e5e5"), 
        plot.background = element_rect(fill = "#293241"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()
        ) + 
  labs(y="",x="",title="DEATH OF CLIMBERS COMPARED TO GUIDES", fill="", subtitle="1905-2019")+
  scale_fill_manual(values=wes_palette(n=2, name="Royal1"))
```

```{r,message=FALSE}
#death rates and total deaths by peak
by_peak <- members %>% 
  group_by(peak_name) %>% 
  mutate(climbers = n()) %>% 
  add_count(died) %>% 
  filter(died) %>%
  mutate(rate = n / (climbers + n) * 100) %>% 
  ungroup() %>% 
  distinct(peak_name, n, rate) %>% 
  slice_max(rate, n = 8) %>% 
  left_join(peaks) %>% 
  mutate(peak_name = fct_reorder(peak_name, rate))

#plot (reference: @gkaramanis)
plot_peaks <- ggplot(by_peak) +
  geom_col(aes(peak_name, rate), width = 0.3, fill = "#d1d1d1") +
  geom_text(aes(peak_name, rate + 3, label = paste(round(rate, 1), "%"))) +
  geom_text(aes(peak_name, 2.5, label = n), color = "#293241") +
  geom_text(aes(peak_name, -4, label = paste0(peak_name, "\n", height_metres, " m")), lineheight = 0.9, size = 3) +
	annotate("text", x = 0.7, y = 30, label = toupper("Death rates and\ntotal deaths by peak\n1905-2019"), hjust = 0, lineheight = 0.9) +
  coord_cartesian(clip = "off") +
  theme_void() +
  theme(
    plot.background = element_rect(fill = "#293241", color = NA),
    plot.margin = margin(15, 0, 0, 0)
    )
plot_peaks
```


```{r,message=FALSE,warning=FALSE}
#How has the rate of expedition success and member death changed over time?
p1 = members %>%
  group_by(year = 10 * (year %/% 10)) %>%
  summarise(
    died = mean(died),
    success = mean(success)
  ) %>%
  pivot_longer(died:success, names_to = "outcome", values_to = "percent") %>%
  ggplot(aes(year, percent, color = outcome)) +
  geom_line(alpha = 0.7, size = 1) +
  scale_y_continuous(labels = scales::percent_format(),limits=c(0,0.5)) +
  labs(x = NULL, y = "% of expedition members", color = NULL, title="Rate of expedition success over time") +
  dark_theme_minimal() + 
  scale_color_simpsons() + 
  theme(legend.position="bottom",
        plot.title=element_text(size=11,hjust=-0.9),
        plot.background = element_rect(fill = "#293241"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.y = element_text(size=9)) 

#Is there a relationship between the expedition member’s age and success of the expedition or death? We can use the same code but just switch out year for age.
p2 = members %>%
  group_by(age = 10 * (age %/% 10)) %>%
  summarise(
    died = mean(died),
    success = mean(success)
  ) %>%
  pivot_longer(died:success, names_to = "outcome", values_to = "percent") %>%
  ggplot(aes(age, percent, color = outcome)) +
  geom_line(alpha = 0.7, size = 1.5) +
  scale_y_continuous(labels = scales::percent_format(),limits=c(0,0.5)) +
  labs(x = NULL, y = "% of expedition members", color = NULL, title="Member’s age and success of the expedition") +
  dark_theme_minimal() + 
  scale_color_simpsons() + 
  theme(legend.position="bottom",
        plot.title=element_text(size=11,hjust=4.2),
        plot.background = element_rect(fill = "#293241"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        axis.title.y = element_text(size=9)) 

grid.arrange(p1,p2,nrow=1)
```


```{r}
#Are people more likely to die on unsuccessful expeditions?
members %>%
  count(success, died) %>%
  group_by(success) %>%
  mutate(percent = scales::percent(n / sum(n))) %>%
  kable(
    col.names = c("Expedition success", "Died", "Number of people", "% of people"),
    align = "llrr"
  )
```

```{r}
#rates of death on different peaks in the Himalayas
members %>%
  filter(!is.na(peak_name)) %>%
  mutate(peak_name = fct_lump(peak_name, prop = 0.05)) %>%
  count(peak_name, died) %>%
  group_by(peak_name) %>%
  mutate(percent = scales::percent(n / sum(n))) %>%
  kable(
    col.names = c("Peak", "Died", "Number of people", "% of people"),
    align = "llrr"
  )
```

```{r,message=FALSE}
#difference in survival across seasons
members %>%
  filter(season != "Unknown") %>%
  count(season, died) %>%
  group_by(season) %>%
  mutate(
    percent = n / sum(n),
    died = case_when(
      died ~ "Died",
      TRUE ~ "Did not die"
    )
  ) %>%
  ggplot(aes(season, percent, fill = season)) +
  geom_col(alpha = 0.8, position = "dodge", show.legend = FALSE,width=0.6) +
  scale_y_continuous(labels = scales::percent_format()) +
  facet_wrap(~died, scales = "free") +
  labs(x = NULL, y = "% of expedition members") + dark_theme_minimal() + scale_fill_manual(values=wes_palette(n=4, name="Royal1"))
```



## Section 2
```{r}
#clean data
members_df <- members %>%
  filter(season != "Unknown", !is.na(sex), !is.na(citizenship)) %>%
  select(peak_id, year, season, sex, age, citizenship, hired, success, died) %>%
  mutate(died = case_when(
    died ~ "died",
    TRUE ~ "survived"
  )) %>%
  mutate_if(is.character, factor) %>%
  mutate_if(is.logical, as.integer)

members_df
```
```{r}
#partition
set.seed(123)
members_split <- initial_split(members_df, strata = died)
members_train <- training(members_split)
members_test <- testing(members_split)

#resample
set.seed(123)
members_folds <- vfold_cv(members_train, strata = died)
members_folds
```

```{r}
#data preprocessing 

members_rec <- recipe(died ~ ., data = members_train) %>%
  step_medianimpute(age) %>%
  step_other(peak_id, citizenship) %>%
  step_dummy(all_nominal(), -died) %>%
  step_smote(died)

members_rec
```

```{r}
#LR model spec
glm_spec <- logistic_reg() %>%
  set_engine("glm")
glm_spec

#RF model spec
rf_spec <- rand_forest(trees = 1000) %>%
  set_mode("classification") %>%
  set_engine("ranger")
rf_spec

#tidymodels workflow
members_wf <- workflow() %>%
  add_recipe(members_rec)
members_wf
```

```{r}
#fit LR model
members_metrics <- metric_set(roc_auc, accuracy, sensitivity, specificity)

doParallel::registerDoParallel()
glm_rs <- members_wf %>%
  add_model(glm_spec) %>%
  fit_resamples(
    resamples = members_folds,
    metrics = members_metrics,
    control = control_resamples(save_pred = TRUE)
  )

glm_rs

#fit RF model 
rf_rs <- members_wf %>%
  add_model(rf_spec) %>%
  fit_resamples(
    resamples = members_folds,
    metrics = members_metrics,
    control = control_resamples(save_pred = TRUE)
  )

rf_rs
```

#Evaluate model 
```{r}
collect_metrics(glm_rs)
collect_metrics(rf_rs)

glm_rs %>%
  conf_mat_resampled()
rf_rs %>%
  conf_mat_resampled()
```
* While the RF has a higher accuracy than LR, the sensitivity is very low. 

```{r}
#plot roc curve
glm_rs %>%
  collect_predictions() %>%
  group_by(id) %>%
  roc_curve(died, .pred_died) %>%
  ggplot(aes(1 - specificity, sensitivity, color = id)) +
  geom_abline(lty = 2, color = "gray80", size = 1.5) +
  geom_path(show.legend = FALSE, alpha = 0.6, size = 1.2) +
  coord_equal() + dark_theme_light() + scale_color_simpsons()
```

```{r}
#one last fit and evaluate on the testing data
members_final <- members_wf %>%
  add_model(glm_spec) %>%
  last_fit(members_split)

members_final
```

```{r}
#metrics and predictions on testing data
collect_metrics(members_final)
collect_predictions(members_final) %>%
  conf_mat(died, .pred_class)

```
```{r}
#get odds ratio
members_final %>%
  pull(.workflow) %>%
  pluck(1) %>%
  tidy(exponentiate = TRUE) %>%
  arrange(estimate) %>%
  kable(digits = 3)
```

```{r}
#visualize results
members_final %>%
  pull(.workflow) %>%
  pluck(1) %>%
  tidy() %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(estimate, fct_reorder(term, estimate))) +
  geom_vline(xintercept = 0, color = "gray50", lty = 2, size = 1.2) +
  geom_errorbar(aes(
    xmin = estimate - std.error,
    xmax = estimate + std.error
  ),
  width = .2, color = "gray50", alpha = 0.7
  ) +
  geom_point(size = 2, color = "#ffb700") +
  labs(y = NULL, x = "Coefficent from logistic regression") + dark_theme_light() 
```

