---
title: "Pet Food Orders"
output: html_notebook
---
**Data source**: [Pet Food Customer Orders Online](https://www.kaggle.com/jahangirraina/pet-food-customer-orders-online) 

**Reference notebook**: [Pet Food Customer Orders Data Insights](https://www.kaggle.com/jahangirraina/pet-food-customer-orders-data-insights)

**Dataset description**: Dataset containing customer orders from a subscription business, where each order is a dry food order along with pet characteristics and some of the orders contain wet food and treats purchase.   


**Research questions**: 

What are the key features for explaining: 

  * treats purchase
  * wet food purchase
  * follow-up wet food purchase


**Notebook contents**: 

* Data preparation
* Feature extraction and labeling
* Data visualization
* Clustering analysis
* Model-based feature importances


#### Load packages
```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(Hmisc)
library(skimr)
library(lubridate)
library(ggsci)
library(viridis)
library(hrbrthemes)
library(corrplot)
library(ggpubr)
library(factoextra)
library(pscl)
library(rpart)
library(rpart.plot)
library(rattle)
library(randomForest)
library(caret)
library(pROC)
```


#### Import data
```{r}
petfood = read.csv("pet_food_customer_orders.csv",header=TRUE)
dim(petfood)  
```
* Dataset contains 49042 dry food orders with 36 variables

```{r}
skim(petfood)
```

## Data preparation
#### Parse and format dates
```{r}
df = petfood
df$order_payment_date = as_date(df$order_payment_date)
df$last_customer_support_ticket_date = as_date(df$last_customer_support_ticket_date)
df %>% summarise (min_date = min(order_payment_date), max_date = max(order_payment_date))
#get year month of order payment date
df = df %>%
  mutate(
    date = ymd(order_payment_date),
    ym = format_ISO8601(date, precision = "ym")
  )
```

#### Order count by year-month
```{r}
df %>% group_by(ym) %>% tally() %>% mutate(prop=round(n/sum(n),4))
```
* dataset contains orders from 2018-12-30 to 2020-03-30. 
* January-2020 has the most dry food transactions 


#### Orders (customers and pets)
```{r}
#count of unique customer ID
length(unique(df$customer_id)) 
#count of unique pets ID
length(unique(df$pet_id))
#no of orders by customer ID
orders_c = df %>% group_by(customer_id) %>% tally(sort=TRUE) %>% as.data.frame
summary(orders_c$n)
#no of orders by pet ID
orders_p= df %>% group_by(pet_id) %>% tally(sort=TRUE) %>% as.data.frame
summary(orders_p$n)
```
* 11168 customers in the dataset with a median of 3 dry food orders.  
* 13087 pets in the dataset with a  median of 3 dry food orders. 

#### Orders and active subscription
```{r}
df %>% group_by(pet_has_active_subscription) %>% tally(sort=TRUE) %>% mutate(prop=round(n/sum(n),3))
```
* 16147 out of 49042 orders (32.9%) in the dataset had an active subscription. 

## Feature extraction and labeling
#### Number of pets in a household 
```{r}
df = df %>% group_by(customer_id) %>% mutate(pets_household =  n_distinct(pet_id)) 
summary(df$pets_household) 
df %>% group_by(customer_id) %>% filter(!duplicated(customer_id)) %>% group_by(pets_household) %>% tally() %>% mutate(prop= round(n/sum(n),4))
```

#### Customer support
```{r}
#communication gap (days between order_payment_date & last_support_ticket_date) 
df$comm_gap = as.numeric(df$date-df$last_customer_support_ticket_date)
summary(df$comm_gap)
```
* mean communication gap of 105.7 days
* 38762 out of 49042 orders do not have last_customer_support_ticket_date

```{r}
#has communication
df = df %>% mutate_at(vars(comm_gap), ~replace(., is.na(.), 0))
df$has_comm = ifelse(df$comm_gap >0,"1","0")
Hmisc::describe(df$has_comm)
```
* 9286 out of 49042 orders have at least one communication

```{r}
#comm gap by customer support ticket category
df %>% group_by(customer_support_ticket_category) %>% summarise(mean_comm_gap = mean(comm_gap)) %>% arrange(mean_comm_gap)
```
```{r}
#customer support ticket category 
df %>% filter(has_comm==1) %>% group_by(customer_support_ticket_category) %>% tally(sort=TRUE) %>% mutate(prop=n/sum(n)) %>% as.data.frame() 
```
* Of those orders that have communication, 
  + 39 obs don't have a ticket category assigned support category 
  + Account category (n=1952) is the largest category of customer support ticket (21%)
  
#### Days before closing 
```{r}
#days between order_payment_date and max order_payment date
df$days_before_closing = as.numeric(max(df$date) - df$order_payment_date)
summary(df$days_before_closing)
```

#### Ratio of wet & dry calories in an order
```{r}
df = df %>% mutate(ratio_kcal = wet_kcal/kibble_kcal) %>% mutate(ratio_kcal= round(ratio_kcal,2))
summary(df$ratio_kcal)
```

### Data aggregation (by pet_id)
```{r}
#drop customer_id
df2 = df %>% ungroup %>% select(-customer_id, -comm_gap, -ym, -date)
```

```{r}
#change na to 0
df2 = df2 %>% mutate_at(vars(wet_food_discount_percent, wet_food_order_number), ~replace(., is.na(.), 0))
```

#### Numeric variables
```{r}
df2 = df2 %>% group_by(pet_id) %>% mutate (
    wet_food_order_number_max = max(wet_food_order_number),
    pet_order_number_max = max(pet_order_number), 
    kibble_kcal_mean= mean(kibble_kcal),
    wet_food_discount_percent_mean = mean(wet_food_discount_percent),
    total_minutes_on_website_since_last_order_mean = mean(total_minutes_on_website_since_last_order),
    pets_household_mean = mean(pets_household),
    has_comm_max = max(has_comm), 
    days_before_closing_max = max(days_before_closing),
    ratio_kcal_mean = mean(ratio_kcal),
    premium_treat_packs_sum = sum(premium_treat_packs),
    dental_treat_packs_sum = sum(dental_treat_packs)
          ) %>% as.data.frame()
```

#### Categorical variables
```{r}
df2a = df2
df2a$allergen_specified = ifelse(df2a$pet_allergen_list=="","0","1")
Hmisc::describe(df2a$allergen_specified)
df2a$fav_flavour_specified = ifelse(df2a$pet_fav_flavour_list=="","0","1")
Hmisc::describe(df2a$fav_flavour_specified)
df2a$health_issue_specified = ifelse(df2a$pet_health_issue_list=="","0","1")
Hmisc::describe(df2a$health_issue_specified)
df2a$dry_food_brand_specified = ifelse(df2a$dry_food_brand_pre_tails=="","0","1")
Hmisc::describe(df2a$dry_food_brand_specified)

df2a = df2a %>% mutate_at(vars(pet_has_active_subscription, pet_food_tier, allergen_specified, fav_flavour_specified, health_issue_specified, neutered, gender, pet_breed_size, signup_promo, ate_wet_food_pre_tails, dry_food_brand_specified, pet_life_stage_at_order, has_comm_max), list(factor))
```

#### Select variables for further analysis
```{r}
df3 = df2a %>% select (pet_id, wet_food_order_number_max,pet_order_number_max,kibble_kcal_mean,wet_food_discount_percent_mean,total_minutes_on_website_since_last_order_mean,pets_household_mean, days_before_closing_max, ratio_kcal_mean,premium_treat_packs_sum, dental_treat_packs_sum, pet_has_active_subscription, pet_food_tier, allergen_specified, fav_flavour_specified, health_issue_specified, neutered, gender, pet_breed_size, signup_promo, ate_wet_food_pre_tails, dry_food_brand_specified, pet_life_stage_at_order, has_comm_max,)
df3 = df3[!duplicated(df3$pet_id,),] 
df3 = df3 %>% ungroup %>% select(-pet_id) #drop pet id
```

```{r}
dim(df3)
summary(df3)
```
```{r}
#check correlation
df3_numeric = select_if(df3,is.numeric)
res=cor(df3_numeric)
corrplot(res, method="color", type="upper", tl.col="#636363", tl.cex=0.5 )
```

#### New variables after aggregation by pet_id
```{r}
#has wet food order
df3$wetfood = ifelse(df3$wet_food_order_number_max >0,"1","0")
Hmisc::describe(df3$wetfood)
```
 * 4363 out of 13087 pets (32.6%) had at least one wet food order
 * 8824 out of 13087 pets (67.4.6%) had no wet food order
 
```{r}
#wet food: follow up order
df3 = df3 %>% mutate(wetfood2 = case_when(wet_food_order_number_max == 0 ~ "0", wet_food_order_number_max == 1 ~ "1", wet_food_order_number_max >= 2 ~ "2")) %>% as.data.frame
Hmisc::describe(df3$wetfood2)  
```
* 1131 pets (0.86 %) had only one wet food order
* 3232 pets (23.9%) had a second wet food order 

```{r}
#has premium treats
df3$premium_t = ifelse(df3$premium_treat_packs_sum >0, "1","0")
Hmisc::describe(df3$premium_t)
#has dental treats
df3$dental_t = ifelse(df3$dental_treat_packs_sum >0, "1","0")
Hmisc::describe(df3$dental_t)
#has both premium and dental treats
df3$both_treats = ifelse(df3$premium_treat_packs_sum >0 & df3$dental_treat_packs_sum >0, "1","0")
Hmisc::describe(df3$both_treats)
```
* 1332 pets (10.2%) has at least one premium treat pack ordered
* 2235 pets (17.1%) has at least one dental treat pack ordered
* 433 pets (3.3%) has at both treats ordered 

```{r}
#has either premium or dental treat pack
df3$total_treat_packs = df3$premium_treat_packs_sum + df3$dental_treat_packs_sum
df3$treats = ifelse(df3$total_treat_packs >0,"1","0")
Hmisc::describe(df3$treats)
```
* 3134 pets (23.9 %) had at least one (dental/premium) treat pack ordered

## Data visualization

```{r}
#kibble_kcal_mean
kk_treats = ggplot(df3, aes(x=treats, y= kibble_kcal_mean)) + geom_boxplot(color="#606c38") + coord_flip() + theme(axis.title=element_text(size=10))
kk_wetfood = ggplot(df3, aes(x=wetfood, y= kibble_kcal_mean)) + geom_boxplot(color="#457b9d") + coord_flip() + theme(axis.title=element_text(size=10))
kk_wetfood2 = ggplot(df3, aes(x=wetfood2, y= kibble_kcal_mean)) + geom_boxplot(color="#e09f3e") + coord_flip() + theme(axis.title=element_text(size=10)) 
ggarrange(kk_treats, kk_wetfood,kk_wetfood2, ncol=1, nrow=3)
```

```{r}
#total_minutes_on_website_since_last_order_mean
wm_treats= ggplot(df3, aes(x=treats, y=total_minutes_on_website_since_last_order_mean)) + geom_jitter(alpha=0.5, size=0.8, width=0.2, color="#606c38") + theme(legend.position="none", axis.title=element_text(size=9)) + coord_flip() + labs(x="active_sub")
wm_wetfood= ggplot(df3, aes(x=wetfood, y=total_minutes_on_website_since_last_order_mean)) + geom_jitter(alpha=0.5, size=0.8, width=0.2, color="#457b9d") + theme(legend.position="none", axis.title=element_text(size=9)) + coord_flip() + labs(x="active_sub")
wm_wetfood2= ggplot(df3, aes(x=wetfood2, y=total_minutes_on_website_since_last_order_mean)) + geom_jitter(alpha=0.5, size=0.8, width=0.2, color="#e09f3e") + theme(legend.position="none", axis.title=element_text(size=9)) + coord_flip() + labs(x="active_sub")
ggarrange(wm_treats, wm_wetfood,wm_wetfood2, ncol=1, nrow=3)
```

```{r}
#days_before_closing_max
bc_treats = ggplot(df3, aes(x=treats, y= days_before_closing_max)) + geom_boxplot(color="#606c38") + coord_flip() + theme(axis.title=element_text(size=10))
bc_wetfood = ggplot(df3, aes(x=wetfood, y= days_before_closing_max)) + geom_boxplot(color="#457b9d") + coord_flip() + theme(axis.title=element_text(size=10))
bc_wetfood2 = ggplot(df3, aes(x=wetfood2, y= days_before_closing_max)) + geom_boxplot(color="#e09f3e") + coord_flip() + theme(axis.title=element_text(size=10)) 
ggarrange(bc_treats, bc_wetfood,bc_wetfood2, ncol=1, nrow=3)
```

```{r}
#proportion: pet_has_active_subscription
as_order = df %>% group_by(pet_has_active_subscription) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=pet_has_active_subscription, fill = pet_has_active_subscription, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Transactions") + scale_fill_uchicago()  + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
as_treats = df3 %>% group_by(treats, pet_has_active_subscription) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=treats, fill = pet_has_active_subscription, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: treats") + scale_fill_uchicago()  + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
as_wetfood = df3 %>% group_by(wetfood,pet_has_active_subscription) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=wetfood, fill = pet_has_active_subscription, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: wetfood") + scale_fill_uchicago()  + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
as_wetfood2 = df3 %>% group_by(wetfood2,pet_has_active_subscription) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=wetfood2, fill = pet_has_active_subscription, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion",title="Label: wetfood2") + scale_fill_uchicago() + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
ggarrange(as_order, as_treats, as_wetfood, as_wetfood2, ncol=2, nrow=2, common.legend = TRUE, legend = "bottom")
```

```{r}
#proportion: pet_life_stage_at_order 
s_order = df %>% group_by(pet_life_stage_at_order) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=pet_life_stage_at_order, fill = pet_life_stage_at_order, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Transactions") + scale_fill_brewer(palette = "Set1") + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
s_wetfood = df3 %>% group_by(wetfood,pet_life_stage_at_order) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=wetfood, fill = pet_life_stage_at_order, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: wetfood") + scale_fill_brewer(palette = "Set1") + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
s_wetfood2 = df3 %>% group_by(wetfood2,pet_life_stage_at_order) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=wetfood2, fill = pet_life_stage_at_order, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: wetfood2") + scale_fill_brewer(palette = "Set1") + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
s_treats = df3 %>% group_by(treats,pet_life_stage_at_order) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=treats, fill = pet_life_stage_at_order, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: treats") + scale_fill_brewer(palette = "Set1") + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
ggarrange(s_order, s_treats, s_wetfood, s_wetfood2, ncol=2, nrow=2, common.legend = TRUE, legend = "bottom")
```

```{r}
#proportion: pet_food_tier
t_order = df %>% group_by(pet_food_tier) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=pet_food_tier, fill = pet_food_tier, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Transactions") + scale_fill_jco() + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
t_treats = df3 %>% group_by(treats, pet_food_tier) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=treats, fill = pet_food_tier, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: treats") + scale_fill_jco() + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
t_wetfood = df3 %>% group_by(wetfood,pet_food_tier) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=wetfood, fill = pet_food_tier, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: wetfood") + scale_fill_jco() + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
t_wetfood2 = df3 %>% group_by(wetfood2,pet_food_tier) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=wetfood2, fill = pet_food_tier, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion",title="Label: wetfood2") + scale_fill_jco() + theme(axis.title = element_text(size=9), plot.title = element_text(size=11))
ggarrange(t_order, t_treats, t_wetfood, t_wetfood2, ncol=2, nrow=2, common.legend = TRUE, legend = "bottom")
```

```{r}
#proportion: signup_promo
sp_order = df %>% group_by(signup_promo) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot( aes(x=signup_promo, y=prop) ) +
    geom_segment( aes(x=signup_promo,xend=signup_promo, y=0, yend=prop), color="grey") +
    geom_point(size=2, color="#294c60") + coord_flip() + theme_light() + theme(panel.grid.major.x = element_blank(), panel.border = element_blank(), axis.ticks.x = element_blank(),axis.ticks.y = element_blank(),panel.grid.major.y = element_blank(), panel.grid.minor.x = element_blank(),axis.title = element_text(size=9),plot.title = element_text(size=11)
  ) + labs(x="signup_promo", y="proportion", title="Transactions") + ylim(0.00,0.30)
sp_treats = df3 %>% group_by(treats, signup_promo) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=signup_promo, fill = treats, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: treats") + scale_fill_jama()  + theme(axis.title = element_text(size=9), plot.title = element_text(size=11)) + coord_flip() + ylim(0.00,0.30)
sp_wetfood = df3 %>% group_by(wetfood, signup_promo) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=signup_promo, fill = wetfood, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: wetfood") + scale_fill_jama()  + theme(axis.title = element_text(size=9), plot.title = element_text(size=11)) + coord_flip() + ylim(0.00,0.30)
sp_wetfood2 = df3 %>% group_by(wetfood2, signup_promo) %>% tally() %>% mutate (prop = n/sum(n)) %>% ggplot(aes(x=signup_promo, fill = wetfood2, y= prop)) + geom_bar(position="dodge", stat="identity") + labs(y="proportion", title="Label: wetfood2") + scale_fill_jama()  + theme(axis.title = element_text(size=9), plot.title = element_text(size=11)) + coord_flip() + ylim(0.00,0.30)
```

```{r fig.width=7, fig.height=4, echo=FALSE}
ggarrange(sp_order, sp_treats, sp_wetfood, sp_wetfood2, ncol=2, nrow=2)
```

## Clustering 
* Find pet groups based on kibbles orders, wet food orders and treat packs (premium + dental) purchased using the aggregated data (by pet_id)

```{r}
#scale 
cdf = df3 %>% select(pet_order_number_max,wet_food_order_number_max, total_treat_packs)
cdfscaled = scale(cdf)
head(cdfscaled)
```

```{r}
#hierarchical clustering dendrogram
set.seed(1234)
h2= hclust(dist(cdfscaled))
plot(h2)
```

```{r}
#check optimal clusters using elbow method
set.seed(123)
fviz_nbclust(cdfscaled,kmeans,method="wss") #4 clusters
```

```{r}
#k-means with 4 clusters
set.seed(123)
km4= kmeans(cdfscaled,centers=4,nstart=50)
km4
```
```{r}
#cluster plot
fviz_cluster(km4, data=cdfscaled, labelsize=0) 
#pair plot
with(cdf,pairs(cdfscaled,col=(1:4)[km4$cluster]))
```

```{r}
cdf1 = df3 %>% select(pet_order_number_max,wet_food_order_number_max, total_treat_packs, pet_has_active_subscription, pets_household_mean)
#summary by km4 cluster id
cdf1$clusterid=km4$cluster
cdf1$clusterid=as.factor(cdf1$clusterid)
by(cdf1,cdf1$clusterid,summary)
```

#### Summary of clustering

* Optimal k: 4
* Cluster size: c1(9519) > c4 (1927) > c3 (1306) > c4 (335)
* Comparing the cluster means:
  + c1: biggest group, lowest wet food orders
  + c2: smallest group, highest kibble orders, highest treat packs 
  + c3: highest wet food orders, second highest treat packs
  + c4: lowest kibble order count and lowest treat packs 
* Ideal group: 
  + c3 for high wet food orders
  + c2 for high kibble orders and treat packs 
* Looking at clusters with pets_household variable:
  + c1 (1.403)  > c2; c3 (1.337) > c4 (1.328)
* Looking at clusters with active subscription variable: 
  + c2 (75.2%) > c1 (74.5 %) > c3 (71.6%) > c4 (55.5%)
  + the cluster (c4) with lowest kibble count and lowest treat packs have a lower proportion of active subscription 


## Model-based feature importances

* The section is focused on identifying which are the important features for predicting **treats** (has treats purchase), **wetfood** (has wet food order) and **wetfood2** (has follow up wet food order). Hence, the models used included as many features as possible. 
* The algorithms decision tree, logistic regression and random forest are used for classification 

### Target variable: treats
```{r}
df3$treats = as.factor(df3$treats)
#select variables
d1 = df3 %>% select (treats, wet_food_order_number_max,pet_order_number_max,kibble_kcal_mean,wet_food_discount_percent_mean,total_minutes_on_website_since_last_order_mean,pets_household_mean,has_comm_max,days_before_closing_max, ratio_kcal_mean, pet_has_active_subscription, pet_food_tier, allergen_specified, fav_flavour_specified, health_issue_specified, dry_food_brand_specified, neutered, gender, pet_breed_size, signup_promo, ate_wet_food_pre_tails, pet_life_stage_at_order)
dim(d1)
```

#### Test and train set
```{r}
dim(df3)
13087 * 0.8 
```

```{r}
set.seed(123)
y1= sample(1:13087,10470)
xtrain=d1[y1,]
xtest=d1[-y1,]
Hmisc:: describe(xtrain$treats)
Hmisc:: describe(xtest$treats)
```

#### Decision tree
```{r}
mt = rpart(treats ~., data = xtrain, method = "class", control = rpart.control(minsplit = 1, minbucket = 1, cp = 0.01))
fancyRpartPlot(mt)
printcp(mt)
mt$variable.importance
```
```{r}
#visualize variable importance
v1 = data.frame(imp = mt$variable.importance)
v2 <- v1 %>% 
  tibble::rownames_to_column() %>% 
  dplyr::rename("variable" = rowname) %>% 
  dplyr::arrange(imp) %>%
  dplyr::mutate(variable = forcats::fct_inorder(variable))
ggplot2::ggplot(v2) +
  geom_col(aes(x = variable, y = imp, fill= imp),
           col = "white", show.legend = F) +
  coord_flip() +
  scale_fill_viridis() +
  theme_minimal() + labs(x="Variable", y="Importance")
```
```{r}
#prediction
tree.p = predict(mt, xtest, type = "class")
cmt = confusionMatrix(tree.p, xtest$treats)
cmt
round(cmt$byClass["F1"], 4)
xtest$tp1= tree.p
roc_t1= roc(response= xtest$treats, predictor = factor(xtest$tp1, ordered=TRUE), plot=TRUE, print.auc=TRUE)
```

#### Logistic regression
```{r}
model1= glm(treats ~., data=xtrain, family = "binomial")
summary(model1) 
pR2(model1)  
anova(model1, test= "Chisq")
```
```{r, message = FALSE, warning = FALSE}
#prediction
prob=predict(model1,xtest,type="response")
prob1=rep(0,2617)
prob1[prob>0.5]=1
cmlr = confusionMatrix(as.factor(prob1), xtest$treats)
cmlr
round(cmlr$byClass["F1"], 4)
roc_lr2 = roc(xtest$treats, prob1, plot=TRUE, print.auc=TRUE)
```

#### Random Forest
```{r}
set.seed(4543)
rf <- randomForest(treats ~ ., data=xtrain)
importance(rf)
varUsed(rf, by.tree=FALSE, count =TRUE)
varImpPlot(rf)
```
```{r}
#prediction
rfp = predict(rf, xtest)
cmrf = confusionMatrix(rfp, xtest$treats)
cmrf
round(cmrf$byClass["F1"], 4)
xtest$rfp= rfp
roc_rf= roc(response= xtest$treats, predictor = factor(xtest$rfp, ordered=TRUE), plot=TRUE, print.auc=TRUE)
```

### Target variable: wetfood 
```{r}
df3$wetfood = as.factor(df3$wetfood) 
#select variables
d2 = df3 %>% select (wetfood,pet_order_number_max,kibble_kcal_mean,total_minutes_on_website_since_last_order_mean,pets_household_mean,has_comm_max,days_before_closing_max, premium_treat_packs_sum, dental_treat_packs_sum, pet_has_active_subscription, pet_food_tier, allergen_specified, fav_flavour_specified, health_issue_specified, dry_food_brand_specified, neutered, gender, pet_breed_size, signup_promo, pet_life_stage_at_order, ate_wet_food_pre_tails)
dim(d2)
```

#### Test and train set
```{r}
set.seed(1234)
y1= sample(1:13087,10470)
xtrain2=d2[y1,]
xtest2=d2[-y1,]
Hmisc:: describe(xtrain2$wetfood)
Hmisc:: describe(xtest2$wetfood)
```

#### Decision tree
```{r}
mt2 = rpart(wetfood ~., data = xtrain2, method = "class")
fancyRpartPlot(mt2)
printcp(mt2)
mt2$variable.importance
```
```{r}
#visualize variable importance
v3 = data.frame(imp = mt2$variable.importance)
v4 <- v3 %>% 
  tibble::rownames_to_column() %>% 
  dplyr::rename("variable" = rowname) %>% 
  dplyr::arrange(imp) %>%
  dplyr::mutate(variable = forcats::fct_inorder(variable))
ggplot2::ggplot(v4) +
  geom_col(aes(x = variable, y = imp, fill= imp),
           col = "white", show.legend = F) +
  coord_flip() +
  scale_fill_viridis() +
  theme_minimal() + labs(x="Variable", y="Importance")
```
```{r}
#prediction
tree.p2 = predict(mt2, xtest2, type = "class")
cmt2 = confusionMatrix(tree.p2, xtest2$wetfood)
cmt2
round(cmt2$byClass["F1"], 4)
xtest2$tp2= tree.p2
roc_t2= roc(response= xtest2$wetfood, predictor = factor(xtest2$tp2, ordered=TRUE), plot=TRUE, print.auc=TRUE)
```

#### Logistic regression
```{r}
model2= glm(wetfood ~., data=xtrain2, family = "binomial")
summary(model2) 
pR2(model2)  
anova(model2, test= "Chisq")
```
```{r}
#prediction
prob=predict(model2,xtest2,type="response")
prob1=rep(0,2617)
prob1[prob>0.5]=1
cmlr = confusionMatrix(as.factor(prob1), xtest2$wetfood)
cmlr
round(cmlr$byClass["F1"], 4)
roc_lr2 = roc(xtest2$wetfood, prob1, plot=TRUE, print.auc=TRUE)
```

#### Random Forest
```{r}
set.seed(4543)
rf2 <- randomForest(wetfood ~ ., data=xtrain2)
importance(rf2)
varUsed(rf2, by.tree=FALSE, count =TRUE)
varImpPlot(rf2)
```
```{r}
#prediction
rfp2 = predict(rf2, xtest2)
cmrf2 = confusionMatrix(rfp2, xtest2$wetfood)
cmrf2
round(cmrf2$byClass["F1"], 4) 
xtest2$rfp2= rfp2
roc_rf= roc(response= xtest2$wetfood, predictor = factor(xtest2$rfp2, ordered=TRUE), plot=TRUE, print.auc=TRUE)
```


### Target variable: wetfood2 
```{r}
 #select variables
d3 = df3 %>% select (wetfood2, pet_order_number_max,kibble_kcal_mean,total_minutes_on_website_since_last_order_mean,pets_household_mean,has_comm_max,days_before_closing_max, premium_treat_packs_sum, dental_treat_packs_sum, pet_has_active_subscription, pet_food_tier, allergen_specified, fav_flavour_specified, health_issue_specified, dry_food_brand_specified, neutered, gender, pet_breed_size, signup_promo, pet_life_stage_at_order, ate_wet_food_pre_tails, wet_food_discount_percent_mean, ratio_kcal_mean)
dim(d3)
#drop obs that do not have any wet food orders 
d3 = d3 %>% filter(!(wetfood2==0)) %>% droplevels()
dim(d3)
```
```{r}
d3 = d3 %>% mutate(wetfood2= recode(wetfood2,`1`="0", `2` ="1" ))
Hmisc::describe(d3$wetfood2)
d3$wetfood2 = as.factor(d3$wetfood2)
```

```{r}
#test and train set
set.seed(2345)
y1= sample(1:4263,3410)
xtrain3=d3[y1,]
xtest3=d3[-y1,]
Hmisc:: describe(xtrain3$wetfood2)
Hmisc:: describe(xtest3$wetfood2)
```

#### Decision tree

```{r}
mt3 = rpart(wetfood2 ~., data = xtrain3, method = "class", control=rpart.control(cp=0, maxdepth = 3, minbucket = 100, minsplit = 100))
fancyRpartPlot(mt3)
printcp(mt3)
mt3$variable.importance
```


```{r}
#visualize variable importance
v3 = data.frame(imp = mt3$variable.importance)
v4 <- v3 %>% 
  tibble::rownames_to_column() %>% 
  dplyr::rename("variable" = rowname) %>% 
  dplyr::arrange(imp) %>%
  dplyr::mutate(variable = forcats::fct_inorder(variable))
ggplot2::ggplot(v4) +
  geom_col(aes(x = variable, y = imp, fill= imp),
           col = "white", show.legend = F) +
  coord_flip() +
  scale_fill_viridis() +
  theme_minimal() + labs(x="Variable", y="Importance")
```

```{r}
#prediction
tree.p3 = predict(mt3, xtest3, type = "class")
cmt3 = confusionMatrix(tree.p3, xtest3$wetfood2)
cmt3
round(cmt3$byClass["F1"], 4)
xtest3$tp3= tree.p3
roc_t3= roc(response= xtest3$wetfood2, predictor = factor(xtest3$tp3, ordered=TRUE), plot=TRUE, print.auc=TRUE)
```

#### Logistic regression
```{r, message = FALSE, warning = FALSE}
model3= glm(wetfood2 ~., data=xtrain3, family = "binomial")
summary(model3) 
pR2(model3)  
anova(model3, test= "Chisq")
```

```{r}
#prediction
prob=predict(model3,xtest3,type="response")
prob1=rep(0,853)
prob1[prob>0.5]=1
cmlr = confusionMatrix(as.factor(prob1), xtest3$wetfood2)
cmlr
round(cmlr$byClass["F1"], 4)
roc_lr2 = roc(xtest3$wetfood2, prob1, plot=TRUE, print.auc=TRUE)
```

#### Summary of important variables

Target variable: treats (has treats pack purchase)

* Decision tree (signup_promo, pet_life_stage_at_order, days_before_closing_max, neutered and pet_order_number_max)
* Logistic regression (signup_promo, wet_food_order_number_max, pet_life_stage_at_order, pet_order_number_max, total_minutes_on_website_since_last_order_mean)
* Random forest (days_before_closing_max, kibble_kcal_mean, signup_promo, total_minutes_on_website_since_last_order_mean, pet_order_number_max) 

Target variable: wetfood (has wet food order)

* Decision tree (ate_wet_food_pre_tails, allergen_specified, pet_life_stage_at_order, signup_promo, total_minutes_on_website_since_last_order_mean) 
* Logistic regression (ate_wet_food_pre_tails, pet_life_stage_at_order, allergen_specified, kibble_kcal_mean, dry_food_brand_specified)
* Random Forest (ate_wet_food_pre_tails, kibble_kcal_mean, days_before_closing_max, total_minutes_on_website_since_last_order_mean, signup_promo)

Target variable: wetfood2 (has follow up wet food order)

* Decision tree (wet_food_discount_percent_mean,  pet_order_number_max, ratio_kcal_mean, total_minutes_on_website_since_last_order_mean, kibble_kcal_mean) 
* Logistic regression (pet_order_number_max, wet_food_discount_percent_mean, ratio_kcal_mean, pet_life_stage_at_order, days_before_closing_max)


